[TOC]
### 1建模综述
数据模型就是数组组织和存储方法，强调从业务、数据存取和使用角度合理存储数据。
> 性能、成本、效率、质量之间取得最佳平衡

1. 性能：快速查询所需数据，减少数据IO吞吐；
2. 成本：极大减少不必要的数据冗余，也能实现计算结果复用，极大降低存储和计算成本；
3. 效率：改善用户使用数据的体验，提高使用数据的效率；
4. 质量：改善数据统计口径的不一致性，减少数据计算错误的可能性；

#### 1.1 OLTP和OLAP 
OLTP系统通常面向的主要是数据操作是随机读写，主要采用满足3SN的实体关系模型存储数据，从而在失误处理中解决数据的冗余和一致性问题；  
而OLAP系统面向的主要数据操作是批量读写，事务处理的一致性不是OLAP所关注的，其主要关注数据的整合，以及在一次性的复杂大数据查询和处理中的性能。

#### 1.2 典型数据仓库建模方法论
##### 1.2.1 ER模型
Bill Inmon 提出，从全企业的高度设计一个3NF模型，用实体关系（Entity Relatonship，ER）模型描述企业业务，在范式理论上符合3NF。（和OLTP的3NF相比，它是站在企业角度面向主题的抽象，而不是针对某个具体的业务流程的实体对象关系的抽象）。
- 需要全面了解企业业务和数据
- 实施周期非常长
- 对建模人员的能力要求非常高   

其建模步骤分为三个阶段:  
- 高层模型：一个高度抽象的模型，描述主要的主题以及主题间的关系，用于描述企业的业务总体概况。
- 中层模型：在高层模型的基础上，细化主题的数据项。
- 物理模型（也叫底层模型）：在中层模型的基础上，考虑物理存储，同时基于性能和平台特点进行物理属性的设计，也可能做一些表的合并、分区的设计等。

##### 1.2.2 纬度模型
Ralph Kimball，从分析决策的需求出发构建模型，为分析需求服务。因此重点关注用户如何更快速地完成需求分析，同时具有较好的大规模复杂查询的响应性能。典型的星型模型，以及一些特殊场景下使用的需求模型。  
其设计分为以下几个步骤：  
- 选择需要进行分析决策的业务过程。业务过程可以是单个业务事件，比如交易的支付、退款等；也可以是某个事件的状态，比如当前的账户余额等；还可以是一系列相关业务事件组成的业务流程，具体需要看我们分析的是某些事件发生情况，还是当前状态，或是事件流转效率。
- 选择粒度。在事件分析中，我们要预判所有分析需要细分的程度，从而决定选择的粒度。粒度是维度的一个组合。
- 识别维表。选择好粒度之后，就需要基于此粒度设计维表，包括维度属性，用于分析时进行分组和筛选。
- 选择事实。确定分析需要衡量的指标。
### 2 模型设计
#### 2.1 模型层次
阿里巴巴的数据团队把表数据模型分为三层 ：
- 操作数据层（ODS，operatiional data store）、
- 公共维度模型层（CDM），其中公共维度模型层包括明细数据层（DWD，Data Warehouse Detail）和汇总数据层（DWS，Data Warehouse Summary）
- 应用数据层（ADS，Application Data Store）

![1563853345158](assets/1563853345158.png)

**操作数据层（ ODS ）**：把操作系统数据几乎无处理地存放在数据仓库系统中。  

- 同步：结构化数据增量或全量同步 。
-  结构化：非结构化（日志）结构化处理并存储。
- 累积历史、清洗：根据数据业务需求及稽核和审计要求保存历史数据、清洗数据。 

**公共维度模型层（ CDM ）**：存放明细事实数据、维表数据及公共指标汇总数据 ， 其中明细事实数据、维表数据一般根据 ODS 层数据加工生成 ：公共指标汇总数据一般根据维表数据和明细事实数据加工生成。  

> CDM 层又细分为 DWD 层和 DWS 层，分别是明细数据层和汇总数据层，采用维度模型方法作为理论基础 ， 更多地采用 一些维度退化手法，将维度退化至事实表中，减少事实表和维表的关联 ，提高明细数据表 的易用性 ：同时在汇总数据层， 加强指标的维度退化， 采取更多的宽表化手段构建公共指标数据层，提升公共指标的复用性，减少重复加工。其主要功 能如下:  

- 组合相关和相似数据：采用明细宽表，复用关联计算，减少数据扫描。
- 公共指标统一加工：构建命名规范、口径一致和算法统一的统计指标，为上层数据产品、应用和服务提供公共指标 ; 建立逻辑汇总宽表。
-  建立 一致性维度：建立 一致的数据分析维表，降低数据计算口径、算法不统一的风险。  

**应用数据层（ ADS ）**：存放数据产品个性化的统计指标数据，根据CDM 层与 ODS 层加工生成 。 

- 个性化指标加工：不公用性、复杂性（指数型、比值型、排名型指标）。
- 基于应用的数据组装 ： 大宽表集市、横表转纵表、趋势指标串。 

![1563864554840](assets/1563864554840.png)

数据调用服务优先使用公共维度模型层（ CDM ）数据，当公共层没有数据时，需评估是否需要创建公共层数据，当不需要建设公用的公共层时，方可直接使用操作数据层（ ODS ）数据。应用数据层（ ADS)作为产品特有的个性化数据一般不对外提供数据服务，但是 ADS 作为被服务方也需要遵守这个约定。  

#### 2.2 维度设计
确定纬度属性的几个提示：
1. 尽可能生成丰富的纬度属性  
2. 尽可能多给出包括一些富有意义的文字性描述
3. 区分数值型属性和事实
4. 尽量沉淀出通用的纬度属性

##### 2.2.1 一致性纬度和交叉探查
不同数据域的计算过程使用的纬度不一致，就会导致交叉探查存在问题。
> 举例：2个数据域使用不同的维度列统计出来的数据无法交叉探查；
> 2个数据域使用相同维度列，但是有各自的维度表，各自的维度表可能值个数不同、值个数相同导致最后结果无法交叉探查；值枚举个数相同，但是单位不同，导致交叉探查还得转换统一单位。

维度一致性办法：
1. 共享维表。
2. 一致性上卷，一个维度是另一个维度的子集。
3. 交叉属性，2个维度具有部分相同的属性。

##### 2.2.2 维度整合
1. 命名规范统一
2. 字段类型统一
3. 公共代码以及代码值统一
4. 业务含义相同表统一

##### 2.2.3 缓慢变化维
维度属性随着时间的流逝发生缓慢变化。
> 与事实表相同，维度变化相对较慢。

三种处理办法：
原始记录为：![1563866394247](assets/1563866394247.png)

1. 重写纬度值。该方法不保留历史数据，直接覆盖，会导致历史数据丢失。

   ![1563866424786](assets/1563866424786.png)

2. 插入新的维度行。但是统计的时候会存在问题，就是需要过滤掉老的维度值，不好确认那个是老的值，那个是新的值，如使用更新时间字段，也会增加统计的麻烦性。

![1563866514280](assets/1563866514280.png)

3. 添加维度列，一列为新值，一列为旧值 

   ![1563866563490](assets/1563866563490.png)



#### 2.3 事实表设计

设计原则：

- 原则 1 ：尽可能包含所有与业务过程相关的事实
- 原则 2 ：只选择与业务过程相关的事实
- 原则 3 ： 分解不可加性事实为可加的组件
- 原则 4：在选择维度和事实之前必须先声明粒度
- 原则 5 ： 在同一个事实表中不能有多种不同粒度的事实
- 原则 6 ：事实的单位要保持一致
- 原则 7 ： 对事实的 null 值要处理
- 原则 8 ：使用退化维度提高事实表的易用性














